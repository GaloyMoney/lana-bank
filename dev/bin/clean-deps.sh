#!/usr/bin/env bash
set -euo pipefail

BASE=docker-compose.yml
DEVENV_OVERRIDE=docker-compose.override.yml  # generated by devenv-init.sh
DOCKER_OVERRIDE=docker-compose.docker.yml    # contains the extra_hosts entry
DAGSTER_FILE=docker-compose.dagster.yml
DAGSTER_OVERRIDE=.devenv/docker-compose.dagster.override.yml
GOTENBERG_FILE=docker-compose.gotenberg.yml
GOTENBERG_OVERRIDE=.devenv/docker-compose.gotenberg.override.yml
MAILCRAB_FILE=docker-compose.mailcrab.yml
MAILCRAB_OVERRIDE=.devenv/docker-compose.mailcrab.override.yml

# ── Pick container engine ───────────────────────────────────────────────────────
if [[ -n "${ENGINE_DEFAULT:-}" ]]; then
  ENGINE="$ENGINE_DEFAULT"
else
  ENGINE=docker
fi

if ! command -v "$ENGINE" >/dev/null 2>&1; then
  printf 'Error: requested engine "%s" not found in $PATH\n' "$ENGINE" >&2
  exit 1
fi

# ── Compose file set ────────────────────────────────────────────────────────────
# Include ALL service files unconditionally for cleanup (down is idempotent).
FILES=(-f "$BASE")
[[ -f "$DEVENV_OVERRIDE" ]] && FILES+=(-f "$DEVENV_OVERRIDE")
FILES+=(-f "$DAGSTER_FILE")
[[ -f "$DAGSTER_OVERRIDE" ]] && FILES+=(-f "$DAGSTER_OVERRIDE")
FILES+=(-f "$GOTENBERG_FILE")
[[ -f "$GOTENBERG_OVERRIDE" ]] && FILES+=(-f "$GOTENBERG_OVERRIDE")
FILES+=(-f "$MAILCRAB_FILE")
[[ -f "$MAILCRAB_OVERRIDE" ]] && FILES+=(-f "$MAILCRAB_OVERRIDE")
[[ "$ENGINE" == docker ]] && FILES+=(-f "$DOCKER_OVERRIDE")   # extra_hosts only on Docker

# ── Down ────────────────────────────────────────────────────────────────────────
"$ENGINE" compose "${FILES[@]}" down -v -t 2

# Release devenv slot and clean generated files after containers are torn down
./dev/bin/devenv-cleanup.sh || true
