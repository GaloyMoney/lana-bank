#!/usr/bin/env bash
set -euo pipefail

# devenv-init.sh — Allocate a dev environment slot and generate config files
#
# Each worktree gets a numeric slot (0-9). All host ports are offset by slot*100.
# Registry: ~/.local/share/lana-bank/devenv-slots (format: <slot>:<abs_path>)
#
# Generated files (all gitignored):
#   .env                        — port assignments + derived URLs
#   docker-compose.override.yml — port overrides + volume mount redirects
#   .devenv/                    — config files with correct ports

REPO_ROOT="$(cd "$(dirname "$0")/../.." && pwd)"
REGISTRY_DIR="${HOME}/.local/share/lana-bank"
REGISTRY_FILE="${REGISTRY_DIR}/devenv-slots"

mkdir -p "${REGISTRY_DIR}"
touch "${REGISTRY_FILE}"

# --- Slot allocation ---

# Check if this worktree already has a slot
SLOT=""
while IFS=: read -r s path; do
  if [[ "${path}" == "${REPO_ROOT}" ]]; then
    SLOT="${s}"
    break
  fi
done < "${REGISTRY_FILE}"

if [[ -z "${SLOT}" ]]; then
  # Clean stale entries (directories that no longer exist)
  CLEANED=""
  while IFS=: read -r s path; do
    if [[ -d "${path}" ]]; then
      CLEANED="${CLEANED}${s}:${path}"$'\n'
    fi
  done < "${REGISTRY_FILE}"
  printf '%s' "${CLEANED}" > "${REGISTRY_FILE}"

  # Find lowest available slot (0-9)
  for candidate in $(seq 0 9); do
    taken=false
    while IFS=: read -r s path; do
      if [[ "${s}" == "${candidate}" ]]; then
        taken=true
        break
      fi
    done < "${REGISTRY_FILE}"
    if [[ "${taken}" == "false" ]]; then
      SLOT="${candidate}"
      echo "${SLOT}:${REPO_ROOT}" >> "${REGISTRY_FILE}"
      break
    fi
  done

  if [[ -z "${SLOT}" ]]; then
    echo "ERROR: No free devenv slots (0-9). Release a slot with devenv-cleanup.sh." >&2
    exit 1
  fi
fi

# --- Port computation ---

OFFSET=$((SLOT * 100))

CORE_PG_PORT=$((5433 + OFFSET))
KEYCLOAK_PG_PORT=$((5437 + OFFSET))
KEYCLOAK_PORT=$((8081 + OFFSET))
KEYCLOAK_MGMT_PORT=$((9000 + OFFSET))
OATHKEEPER_PROXY_PORT=$((4455 + OFFSET))
OATHKEEPER_API_PORT=$((4456 + OFFSET))
OTEL_GRPC_PORT=$((4317 + OFFSET))
OTEL_HTTP_PORT=$((4318 + OFFSET))
ADMIN_SERVER_PORT=$((5253 + OFFSET))
CUSTOMER_SERVER_PORT=$((5254 + OFFSET))
ADMIN_PANEL_PORT=$((3001 + OFFSET))
CUSTOMER_PORTAL_PORT=$((3002 + OFFSET))
DAGSTER_PORT=$((3000 + OFFSET))
GOTENBERG_PORT=$((3030 + OFFSET))
MAILCRAB_SMTP_PORT=$((1025 + OFFSET))
MAILCRAB_WEB_PORT=$((1080 + OFFSET))

# --- Generate .env ---

cat > "${REPO_ROOT}/.env" <<EOF
# Auto-generated by devenv-init.sh — slot ${SLOT}
# Do not edit manually. Re-run devenv-init.sh to regenerate.

COMPOSE_PROJECT_NAME=lana-${SLOT}

# Port assignments (base + slot*100)
CORE_PG_PORT=${CORE_PG_PORT}
KEYCLOAK_PG_PORT=${KEYCLOAK_PG_PORT}
KEYCLOAK_PORT=${KEYCLOAK_PORT}
KEYCLOAK_MGMT_PORT=${KEYCLOAK_MGMT_PORT}
OATHKEEPER_PROXY_PORT=${OATHKEEPER_PROXY_PORT}
OATHKEEPER_API_PORT=${OATHKEEPER_API_PORT}
OTEL_GRPC_PORT=${OTEL_GRPC_PORT}
OTEL_HTTP_PORT=${OTEL_HTTP_PORT}
ADMIN_SERVER_PORT=${ADMIN_SERVER_PORT}
CUSTOMER_SERVER_PORT=${CUSTOMER_SERVER_PORT}
ADMIN_PANEL_PORT=${ADMIN_PANEL_PORT}
CUSTOMER_PORTAL_PORT=${CUSTOMER_PORTAL_PORT}
DAGSTER_PORT=${DAGSTER_PORT}
GOTENBERG_PORT=${GOTENBERG_PORT}
MAILCRAB_SMTP_PORT=${MAILCRAB_SMTP_PORT}
MAILCRAB_WEB_PORT=${MAILCRAB_WEB_PORT}

# Derived URLs
PG_CON=postgres://user:password@127.0.0.1:${CORE_PG_PORT}/pg?sslmode=disable
DATABASE_URL=postgres://user:password@127.0.0.1:${CORE_PG_PORT}/pg?sslmode=disable
OTEL_EXPORTER_OTLP_ENDPOINT=http://localhost:${OTEL_GRPC_PORT}
KC_URL=http://localhost:${KEYCLOAK_PORT}
KEYCLOAK_URL=http://localhost:${KEYCLOAK_PORT}

# Config paths (point to generated copies in .devenv/)
LANA_CONFIG=${REPO_ROOT}/.devenv/bats/lana.yml
LANA_CONFIG_BOOTSTRAP=${REPO_ROOT}/.devenv/bats/lana-bootstrap.yml
LANA_CONFIG_NORMAL=${REPO_ROOT}/.devenv/bats/lana-normal.yml
EOF

# --- Generate .devenv/ config files ---

DEVENV_DIR="${REPO_ROOT}/.devenv"
mkdir -p "${DEVENV_DIR}/ory" "${DEVENV_DIR}/keycloak" "${DEVENV_DIR}/bats"

# Helper: copy file and substitute ports using sed
generate_config() {
  local src="$1" dst="$2"
  sed \
    -e "s|localhost:5253|localhost:${ADMIN_SERVER_PORT}|g" \
    -e "s|localhost:5254|localhost:${CUSTOMER_SERVER_PORT}|g" \
    -e "s|localhost:8081|localhost:${KEYCLOAK_PORT}|g" \
    -e "s|localhost:4455|localhost:${OATHKEEPER_PROXY_PORT}|g" \
    -e "s|localhost:4456|localhost:${OATHKEEPER_API_PORT}|g" \
    -e "s|localhost:3001|localhost:${ADMIN_PANEL_PORT}|g" \
    -e "s|localhost:3002|localhost:${CUSTOMER_PORTAL_PORT}|g" \
    -e "s|localhost:3000|localhost:${DAGSTER_PORT}|g" \
    -e "s|localhost:3030|localhost:${GOTENBERG_PORT}|g" \
    -e "s|internal:5253|internal:${ADMIN_SERVER_PORT}|g" \
    -e "s|internal:5254|internal:${CUSTOMER_SERVER_PORT}|g" \
    -e "s|internal:3001|internal:${ADMIN_PANEL_PORT}|g" \
    -e "s|internal:3002|internal:${CUSTOMER_PORTAL_PORT}|g" \
    -e "s|port: 1025|port: ${MAILCRAB_SMTP_PORT}|g" \
    "${src}" > "${dst}"
}

# Oathkeeper configs
generate_config "${REPO_ROOT}/dev/ory/oathkeeper.yml" "${DEVENV_DIR}/ory/oathkeeper.yml"
generate_config "${REPO_ROOT}/dev/ory/oathkeeper_rules.yaml" "${DEVENV_DIR}/ory/oathkeeper_rules.yaml"

# Copy jwks.json (not templated, but oathkeeper volume needs it)
cp "${REPO_ROOT}/dev/ory/jwks.json" "${DEVENV_DIR}/ory/jwks.json"

# Keycloak realm configs
generate_config "${REPO_ROOT}/dev/keycloak/internal-realm.json" "${DEVENV_DIR}/keycloak/internal-realm.json"
generate_config "${REPO_ROOT}/dev/keycloak/customer-realm.json" "${DEVENV_DIR}/keycloak/customer-realm.json"

# BATS test configs
generate_config "${REPO_ROOT}/bats/lana.yml" "${DEVENV_DIR}/bats/lana.yml"
generate_config "${REPO_ROOT}/bats/lana-bootstrap.yml" "${DEVENV_DIR}/bats/lana-bootstrap.yml"
generate_config "${REPO_ROOT}/bats/lana-normal.yml" "${DEVENV_DIR}/bats/lana-normal.yml"

# Append admin_server and customer_server sections to each BATS config.
# The source YAML files omit these sections, relying on Rust defaults (5253/5254, jwks on 4456).
# For slot > 0 the servers must bind to offset ports and use the correct oathkeeper API port.
for cfg in "${DEVENV_DIR}/bats/lana.yml" "${DEVENV_DIR}/bats/lana-bootstrap.yml" "${DEVENV_DIR}/bats/lana-normal.yml"; do
  cat >> "${cfg}" <<YAML_EOF
admin_server:
  port: ${ADMIN_SERVER_PORT}
  jwks_url: http://localhost:${OATHKEEPER_API_PORT}/.well-known/jwks.json
customer_server:
  port: ${CUSTOMER_SERVER_PORT}
  jwks_url: http://localhost:${OATHKEEPER_API_PORT}/.well-known/jwks.json
YAML_EOF
done

# --- Generate docker-compose.override.yml ---

cat > "${REPO_ROOT}/docker-compose.override.yml" <<EOF
# Auto-generated by devenv-init.sh — slot ${SLOT}
# Overrides port mappings and volume mounts for multi-devenv support.
# Do not edit manually. Re-run devenv-init.sh to regenerate.
services:
  otel-agent:
    ports: ["\${OTEL_GRPC_PORT:-4317}:4317", "\${OTEL_HTTP_PORT:-4318}:4318"]

  keycloak:
    ports: ["\${KEYCLOAK_PORT:-8081}:8080", "\${KEYCLOAK_MGMT_PORT:-9000}:9000"]
    environment:
      KC_HOSTNAME_PORT: \${KEYCLOAK_PORT:-8081}
    volumes:
      - "./.devenv/keycloak:/opt/keycloak/data/import"

  oathkeeper:
    ports: ["\${OATHKEEPER_PROXY_PORT:-4455}:4455", "\${OATHKEEPER_API_PORT:-4456}:4456"]
    volumes:
      - "./.devenv/ory:/home/ory"

  core-pg:
    ports: ["\${CORE_PG_PORT:-5433}:5432"]

  keycloak-pg:
    ports: ["\${KEYCLOAK_PG_PORT:-5437}:5432"]
EOF

# --- Generate optional service override files (in .devenv/) ---
# These are separate files because Docker Compose would error if the main override
# defined services not present in the active file set (no image/build to run).
# docker-compose-up.sh includes these only when the corresponding service is enabled.

cat > "${DEVENV_DIR}/docker-compose.dagster.override.yml" <<EOF
# Auto-generated by devenv-init.sh — slot ${SLOT}
services:
  dagster-code-location-lana-dw:
    container_name: dagster-code-location-lana-dw-${SLOT}
    environment:
      LANA_ADMIN_SERVER_URL: "http://host.containers.internal:\${ADMIN_SERVER_PORT:-5253}"

  dagster_webserver:
    container_name: dagster_webserver-${SLOT}
    ports: ["\${DAGSTER_PORT:-3000}:3000"]

  dagster_daemon:
    container_name: dagster_daemon-${SLOT}
    environment:
      LANA_ADMIN_SERVER_URL: "http://host.containers.internal:\${ADMIN_SERVER_PORT:-5253}"

  dagster_postgres:
    container_name: dagster_postgres-${SLOT}
EOF

cat > "${DEVENV_DIR}/docker-compose.gotenberg.override.yml" <<EOF
# Auto-generated by devenv-init.sh — slot ${SLOT}
services:
  gotenberg:
    ports: ["\${GOTENBERG_PORT:-3030}:3000"]
EOF

cat > "${DEVENV_DIR}/docker-compose.mailcrab.override.yml" <<EOF
# Auto-generated by devenv-init.sh — slot ${SLOT}
services:
  mailcrab:
    ports: ["\${MAILCRAB_SMTP_PORT:-1025}:1025", "\${MAILCRAB_WEB_PORT:-1080}:1080"]
EOF

echo "DevEnv slot ${SLOT} initialized (offset=${OFFSET}, core-pg=${CORE_PG_PORT}, keycloak=${KEYCLOAK_PORT}, oathkeeper=${OATHKEEPER_PROXY_PORT})"
