- id: public-core-api
  upstream:
    url: "http://dockerhost-alias:5252"
  match:
    url: "<(http|https)>://<[a-zA-Z0-9-.:]+>/graphql"
    methods: ["POST", "GET", "OPTIONS"]
  authenticators:
    - handler: cookie_session
    - handler: bearer_token
  authorizer:
    handler: allow
  mutators:
    - handler: id_token
      config:
        claims: '{"sub": "{{ print .Subject }}", "aud": ["https://public-api/graphql"] }'

- id: admin-core-api
  upstream:
    url: "http://dockerhost-alias:5253"
    strip_path: /admin
  match:
    url: "<(http|https)>://<[a-zA-Z0-9-.:]+>/admin/graphql"
    methods: ["POST", "GET", "OPTIONS"]
  authenticators:
    - handler: cookie_session
      config:
        check_session_url: http://dockerhost-alias:3001/api/auth/session
        preserve_path: true
        preserve_query: true
        subject_from: user.email
        extra_from: "@this"
        force_method: "GET"
  authorizer:
    handler: allow
  mutators:
    - handler: id_token
      config:
        claims: '{"sub": "{{ print .Subject }}", "aud": ["https://admin-api/graphql"] }'

- id: admin-panel
  upstream:
    url: "http://dockerhost-alias:3001"
    preserve_host: true
  match:
    url: "<(http|https)>://<[a-zA-Z0-9-.:]+>/<(?!sessions|self-service|admin|graphql).*>"
    methods: ["POST", "GET", "OPTIONS", "PUT", "DELETE", "PATCH"]
  authenticators:
    - handler: noop
  authorizer:
    handler: allow
  mutators:
    - handler: noop

- id: kratos-public
  upstream:
    url: "http://dockerhost-alias:4433"
  match:
    url: "<(http|https)>://<[a-zA-Z0-9-.:]+>/<(sessions|self-service)>/<.*>"
    methods: ["POST", "GET", "OPTIONS", "PUT", "DELETE", "PATCH"]
  authenticators:
    - handler: noop
  authorizer:
    handler: allow
  mutators:
    - handler: noop
# - id: lava-core-customer-portal
#   upstream:
#     url: "http://dockerhost-alias:3000"
#     preserve_host: true
#   match:
#     url: "<(http|https)>://<[a-zA-Z0-9-.:]+>/<(?!sessions|self-service|graphql).*>"
#     methods: ["POST", "GET", "OPTIONS"]
#   authenticators:
#     - handler: cookie_session
#       check_session_url: http://kratos:4433/sessions/whoami
#       preserve_path: true
#       subject_from: identity.id
#       extra_from: identity.traits
#       only:
#         - ory_kratos_session
#     - handler: anonymous
#   authorizer:
#     handler: allow
#   mutators:
#     - handler: noop
# - handler: id_token
#   config:
#     claims: '{"sub": "{{ print .Subject }}", aud: ["https://public-api/graphql"] }'
