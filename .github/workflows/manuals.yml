name: Cypress Tests

on:
  pull_request:
    branches: [main]

jobs:
  tilt-ci:
    name: Tilt CI
    runs-on: ubuntu-latest
    steps:
      - name: Login to GCR
        uses: docker/login-action@v3
        with:
          registry: gcr.io
          username: _json_key
          password: ${{ secrets.GCR_JSON_KEY }}

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@v4

      - name: Run the Magic Nix Cache
        uses: DeterminateSystems/magic-nix-cache-action@v8

      - name: Checkout code
        uses: actions/checkout@v4

      - id: "gcp-auth"
        uses: "google-github-actions/auth@v2"
        with:
          credentials_json: "${{ secrets.GOOGLE_CREDENTIALS }}"

      - name: Build Backend
        run: nix develop -c make build-for-tests

      - name: Sync dataform-branch
        run: nix develop -c make push-dataform-branch
        env:
          DATAFORM_BRANCH: "gha-dataform"

      - name: Run Tilt
        run: nix develop -c make tilt-ci
        env:
          GOOGLE_CREDENTIALS: ${{ secrets.GOOGLE_CREDENTIALS }}
          TF_VAR_sa_creds: ${{ secrets.GOOGLE_SA_BASE64 }}
          SA_CREDS_BASE64: ${{ secrets.GOOGLE_SA_BASE64 }}
          SUMSUB_KEY: ${{ secrets.SUMSUB_KEY }}
          SUMSUB_SECRET: ${{ secrets.SUMSUB_SECRET }}
          TF_VAR_name_prefix: "gha"

      - run: free -h
      - run: df -h

      - name: Run Cypress Tests
        run: nix develop -c make test-cypress-in-headless
        env:
          BROWSERSTACK_USERNAME: ${{ secrets.BROWSERSTACK_USERNAME }}
          BROWSERSTACK_ACCESS_KEY: ${{ secrets.BROWSERSTACK_ACCESS_KEY }}
