name: Audit

on:
  pull_request:
    branches:
      - main
      - "feature/**"

jobs:
  rust_audit:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: false
          android: true
          dotnet: true
          haskell: true
          large-packages: true
          docker-images: true
          swap-storage: true
      - uses: actions-rs/audit-check@v1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

  pnpm_audit:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
      - uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "pnpm"
      - run: pnpm install
      - run: pnpm audit --audit-level=high

  pip_audit:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - name: Install pip-audit
        run: pip install --no-cache-dir pip-audit
      - name: Find every Poetry project and audit
        run: |
          set -euo pipefail
          mapfile -t PROJECT_DIRS < <(
            find . -type f -name 'poetry.lock' -exec dirname {} \; | sort -u
          )

          if [ "${#PROJECT_DIRS[@]}" -eq 0 ]; then
            echo "âš ï¸  No Poetry projects found â€“ skipping pip-audit."
            exit 0
          fi

          for dir in "${PROJECT_DIRS[@]}"; do
            echo ""
            echo "ðŸ” pip-audit â†’ $dir"
            pip-audit "$dir"
          done