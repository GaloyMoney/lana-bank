name: data pipeline

on:
  pull_request:
    branches:
      - main
      - "feature/**"

jobs:
  data-pipeline-tests:
    name: 
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup-podman
      - uses: ./.github/actions/setup-nix
        with:
          cachix_auth_token: ${{ secrets.CACHIX_AUTH_TOKEN }}
          google_credentials: ${{ secrets.GOOGLE_CREDENTIALS }}

      - name: Provision BigQuery infrastructure
        run: |
          # Generate unique name prefix for this run (max 30 chars for GCP service accounts)
          UNIQUE_PREFIX="gha-$(date +%s | tail -c 6)-$(head -c 2 /dev/urandom | xxd -p)"
          echo "UNIQUE_PREFIX=$UNIQUE_PREFIX" >> $GITHUB_ENV

          # Setup credentials
          echo $TF_VAR_sa_creds | base64 -d > /tmp/creds.json
          export GOOGLE_APPLICATION_CREDENTIALS=/tmp/creds.json

          # Create tfvars file
          cd tf/bq-setup
          cat > terraform.tfvars <<EOF
          name_prefix = "$UNIQUE_PREFIX"
          gcp_project = "$(echo $TF_VAR_sa_creds | base64 -d | jq -r '.project_id')"
          gcp_region = "us-central1"
          git_token = "dummy_token"
          EOF

          nix develop -c tofu init
          nix develop -c tofu apply -auto-approve

          SA_CREDS=$(nix develop -c tofu output -raw service_account_key_base64)

          echo "SA_CREDS=$SA_CREDS" >> $GITHUB_ENV
          echo "NAME_PREFIX=$UNIQUE_PREFIX" >> $GITHUB_ENV
        env:
          TF_VAR_sa_creds: ${{ secrets.GOOGLE_SA_BASE64 }}

      - name: Run BATS tests with podman
        run: nix develop -c make e2e
        env:
          ENGINE_DEFAULT: podman
          TF_VAR_sa_creds: ${{ env.SA_CREDS }}
          SA_CREDS_BASE64: ${{ env.SA_CREDS }}
          SUMSUB_KEY: ${{ secrets.SUMSUB_KEY }}
          SUMSUB_SECRET: ${{ secrets.SUMSUB_SECRET }}
          TF_VAR_name_prefix: ${{ env.NAME_PREFIX }}

      - name: Cleanup BigQuery infrastructure
        if: always()
        run: |
          echo $TF_VAR_sa_creds | base64 -d > /tmp/creds.json
          export GOOGLE_APPLICATION_CREDENTIALS=/tmp/creds.json

          cd tf/bq-setup

          # First destroy IAM bindings to avoid dependency issues
          nix develop -c tofu destroy -auto-approve \
            -target=google_bigquery_dataset_iam_member.dbt_owner \
            -target=google_bigquery_dataset_iam_member.dataset_owner_sa \
            -target=google_bigquery_dataset_iam_member.dataset_additional_owners \
            -target=google_bigquery_dataset_iam_member.dbt_additional_owners

          # Then destroy everything else
          nix develop -c tofu destroy -auto-approve
        env:
          TF_VAR_sa_creds: ${{ secrets.GOOGLE_SA_BASE64 }}

      - name: Rename bats log
        if: always()
        run: mv .e2e-logs e2e-logs || true

      - name: Upload bats log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: Podman BATS Logs
          path: |
            e2e-logs
            *.e2e-logs 
