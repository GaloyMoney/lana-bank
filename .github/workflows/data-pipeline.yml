name: data pipeline

on:
  pull_request:
    branches:
      - main
      - "feature/**"

env:
  ENGINE_DEFAULT: podman
  LANA_DOMAIN_CONFIG_SUMSUB_API_KEY: ${{ secrets.SUMSUB_KEY }}
  LANA_DOMAIN_CONFIG_SUMSUB_API_SECRET: ${{ secrets.SUMSUB_SECRET }}
  TARGET_BIGQUERY_LOCATION: "US"

jobs:
  data-pipeline-tests:
    if: ${{ github.actor != 'dependabot[bot]' && !startsWith(github.head_ref, 'dependabot/') }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: true
          android: true
          dotnet: true
          haskell: true
          large-packages: false
          docker-images: true
          swap-storage: true
      - name: Authenticate to Google Cloud
        env:
          GOOGLE_CREDENTIALS: ${{ secrets.GOOGLE_CREDENTIALS }}
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GOOGLE_CREDENTIALS }}
      - uses: DeterminateSystems/nix-installer-action@v16
      - uses: cachix/cachix-action@v15
        with:
          name: galoymoney
          authToken: ${{ secrets.CACHIX_AUTH_TOKEN }}
          skipPush: true

      - name: Provision BigQuery infrastructure
        run: |
          # Generate unique name prefix for this run (max 30 chars for GCP service accounts)
          UNIQUE_PREFIX="gha-$(date +%s | tail -c 6)-$(head -c 2 /dev/urandom | xxd -p)"
          echo "UNIQUE_PREFIX=$UNIQUE_PREFIX" >> $GITHUB_ENV

          # Setup credentials
          echo $TF_VAR_sa_creds | base64 -d > /tmp/creds.json
          export GOOGLE_APPLICATION_CREDENTIALS=/tmp/creds.json

          # Create tfvars file
          cd tf/bq-setup
          cat > terraform.tfvars <<EOF
          name_prefix = "$UNIQUE_PREFIX"
          gcp_project = "$(echo $TF_VAR_sa_creds | base64 -d | jq -r '.project_id')"
          gcp_region = "us-central1"
          git_token = "dummy_token"
          force_destroy_bucket = true
          EOF

          nix develop -c tofu init
          nix develop -c tofu apply -auto-approve

          nix develop -c tofu output -raw service_account_key_base64 > sa_creds_base64.txt
          SA_CREDS=$(tail -n 1 sa_creds_base64.txt)
          rm sa_creds_base64.txt

          echo "SA_CREDS=$SA_CREDS" >> $GITHUB_ENV
          echo "NAME_PREFIX=$UNIQUE_PREFIX" >> $GITHUB_ENV
        env:
          TF_VAR_sa_creds: ${{ secrets.GOOGLE_SA_BASE64 }}

      - name: Configure BigQuery environment
        run: |         
          # Compute all BigQuery/DBT env vars once
          SAFE_PREFIX="$(printf '%s' "$NAME_PREFIX" | tr -c '[:alnum:]_' '_')"
          
          echo "TF_VAR_name_prefix=$NAME_PREFIX" >> $GITHUB_ENV
          echo "DBT_BIGQUERY_PROJECT=$(echo $SA_CREDS_BASE64 | base64 -d | jq -r '.project_id')" >> $GITHUB_ENV
          echo "DBT_BIGQUERY_DATASET=dbt_${SAFE_PREFIX}" >> $GITHUB_ENV
          echo "TARGET_BIGQUERY_DATASET=${SAFE_PREFIX}_dataset" >> $GITHUB_ENV
          echo "DOCS_BUCKET_NAME=${NAME_PREFIX}-lana-documents" >> $GITHUB_ENV
          echo "REPORTS_BUCKET_NAME=${NAME_PREFIX}-lana-documents" >> $GITHUB_ENV
          echo "DBT_BIGQUERY_CREDENTIALS_JSON=$(echo $SA_CREDS_BASE64 | base64 -d | jq -c '.')" >> $GITHUB_ENV

        env:
          SA_CREDS_BASE64: ${{ env.SA_CREDS }}
          NAME_PREFIX: ${{ env.NAME_PREFIX }}

      - name: Run BATS tests
        run: KEEP_PODMAN_UP=1 nix run .#bats
        env:
          TF_VAR_sa_creds: ${{ env.SA_CREDS }}
          SA_CREDS_BASE64: ${{ env.SA_CREDS }}
          TF_VAR_name_prefix: ${{ env.NAME_PREFIX }}
          DBT_BIGQUERY_PROJECT: ${{ env.DBT_BIGQUERY_PROJECT }}
          DBT_BIGQUERY_DATASET: ${{ env.DBT_BIGQUERY_DATASET }}
          DBT_BIGQUERY_CREDENTIALS_JSON: ${{ env.DBT_BIGQUERY_CREDENTIALS_JSON }}
          TARGET_BIGQUERY_DATASET: ${{ env.TARGET_BIGQUERY_DATASET }}
          DOCS_BUCKET_NAME: ${{ env.DOCS_BUCKET_NAME }}
          REPORTS_BUCKET_NAME: ${{ env.REPORTS_BUCKET_NAME }}

      - name: Cleanup BigQuery infrastructure
        if: always()
        run: |
          echo $TF_VAR_sa_creds | base64 -d > /tmp/creds.json
          export GOOGLE_APPLICATION_CREDENTIALS=/tmp/creds.json

          cd tf/bq-setup

          # First destroy IAM bindings to avoid dependency issues
          nix develop -c tofu destroy -auto-approve \
            -target=google_bigquery_dataset_iam_member.dbt_owner \
            -target=google_bigquery_dataset_iam_member.dataset_owner_sa \
            -target=google_bigquery_dataset_iam_member.dataset_additional_owners \
            -target=google_bigquery_dataset_iam_member.dbt_additional_owners

          # Then destroy everything else
          nix develop -c tofu destroy -auto-approve
        env:
          TF_VAR_sa_creds: ${{ secrets.GOOGLE_SA_BASE64 }}

      - name: Rename bats log
        if: always()
        run: mv .e2e-logs e2e-logs || true

      - name: Upload bats log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: Podman BATS Logs
          path: |
            e2e-logs
            *.e2e-logs
