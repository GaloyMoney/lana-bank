name: "Tilt CI"
on:
  pull_request:
    branches: [ main ]
jobs:
  tests:
    runs-on: ubuntu-latest
    steps:
    - name: Login to GCR
      uses: docker/login-action@v3
      with:
        registry: gcr.io
        username: _json_key
        password: ${{ secrets.GCR_JSON_KEY }}
    - uses: actions/checkout@v3
    - uses: cachix/install-nix-action@v22
      with:
        github_access_token: ${{ secrets.GITHUB_TOKEN }}
    - id: "gcp-auth"
      uses: "google-github-actions/auth@v2"
      with:
        credentials_json: "${{ secrets.GOOGLE_CREDENTIALS }}"
    - name: Reset Deps
      run: nix develop -c make reset-deps
    - name: Tilt CI
      run: nix develop -c make tilt-in-ci
      env:
        TF_VAR_sa_creds: ${{ secrets.GOOGLE_SA_BASE64 }}
