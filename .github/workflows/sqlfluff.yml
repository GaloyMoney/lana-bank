name: SQLFluff

on:
  pull_request:
    paths:
      - "meltano/transform/models/**/*.sql"

env:
  TARGET_BIGQUERY_LOCATION: "US"

permissions:
  contents: read

jobs:
  sqlfluff:
    name: Lint SQL with SQLFluff
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install SQLFluff and dbt-bigquery
        run: |
          python -m pip install --upgrade pip
          pip install "sqlfluff>=2.3,<3" "sqlfluff-templater-dbt>=2,<3" "dbt-bigquery~=1.8" "google-cloud-bigquery"

      - name: Configure dbt credentials and profile
        env:
          GOOGLE_SA_BASE64: ${{ secrets.GOOGLE_SA_BASE64 }}
        run: |
          set -euo pipefail
          mkdir -p "$RUNNER_TEMP/gcp"
          echo "${GOOGLE_SA_BASE64}" | base64 -d > "$RUNNER_TEMP/gcp/keyfile.json"
          test -s "$RUNNER_TEMP/gcp/keyfile.json"

          KEYFILE="$RUNNER_TEMP/gcp/keyfile.json"
          PROJECT_ID="$(KEYFILE="$KEYFILE" python - <<'PY'
import json, os
with open(os.environ['KEYFILE']) as f:
    print(json.load(f).get('project_id',''))
PY
)"
          if [ -z "$PROJECT_ID" ]; then
            echo "project_id missing in keyfile" >&2
            exit 1
          fi

          SAFE_PREFIX="sqlfluff_${GITHUB_RUN_ID}_${GITHUB_RUN_ATTEMPT}"
          SAFE_PREFIX="$(printf '%s' "$SAFE_PREFIX" | tr -c '[:alnum:]_' '_' )"

          echo "DBT_BIGQUERY_KEYFILE=$KEYFILE" >> "$GITHUB_ENV"
          echo "DBT_BIGQUERY_PROJECT=$PROJECT_ID" >> "$GITHUB_ENV"
          echo "DBT_BIGQUERY_DATASET=dbt_${SAFE_PREFIX}" >> "$GITHUB_ENV"
          echo "GOOGLE_APPLICATION_CREDENTIALS=$KEYFILE" >> "$GITHUB_ENV"

          mkdir -p "$RUNNER_TEMP/dbt_profiles"
          cat >"$RUNNER_TEMP/dbt_profiles/profiles.yml" <<'YML'
default:
  outputs:
    dev:
      type: bigquery
      method: service-account
      project: "{{ env_var('DBT_BIGQUERY_PROJECT') }}"
      dataset: "{{ env_var('DBT_BIGQUERY_DATASET') }}"
      keyfile: "{{ env_var('DBT_BIGQUERY_KEYFILE') }}"
      location: "{{ env_var('TARGET_BIGQUERY_LOCATION') }}"
      threads: 4
  target: dev
YML
          echo "DBT_PROFILES_DIR=$RUNNER_TEMP/dbt_profiles" >> "$GITHUB_ENV"
          echo "DBT_PROJECT_DIR=$GITHUB_WORKSPACE/meltano/transform" >> "$GITHUB_ENV"

      - name: Install dbt packages (macros)
        env:
          DBT_PROFILES_DIR: ${{ env.DBT_PROFILES_DIR }}
        run: |
          cd meltano/transform
          dbt deps

      - name: Lint SQL with SQLFluff
        env:
          DBT_PROFILES_DIR: ${{ env.DBT_PROFILES_DIR }}
          DBT_PROJECT_DIR: ${{ env.DBT_PROJECT_DIR }}
        run: |
          sqlfluff --version
          sqlfluff lint --dialect bigquery --templater dbt meltano/transform/models
