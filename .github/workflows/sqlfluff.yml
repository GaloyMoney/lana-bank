name: SQLFluff

on:
  push:
    paths:
      - "meltano/transform/models/**/*.sql"
  pull_request:
    paths:
      - "meltano/transform/models/**/*.sql"

env:
  ENGINE_DEFAULT: podman
  TARGET_BIGQUERY_LOCATION: "US"

permissions:
  contents: read

jobs:
  sqlfluff:
    name: Lint SQL with SQLFluff
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup-podman
      - uses: ./.github/actions/setup-nix
        with:
          cachix_auth_token: ${{ secrets.CACHIX_AUTH_TOKEN }}
          google_credentials: ${{ secrets.GOOGLE_CREDENTIALS }}

      - name: Configure Meltano environment variables
        run: |
          echo "TF_VAR_name_prefix=$TF_VAR_name_prefix" >> $GITHUB_ENV
          echo $SA_CREDS_BASE64 | base64 --decode > meltano/keyfile.json

          export TARGET_BIGQUERY_CREDENTIALS_JSON=$(cat meltano/keyfile.json)
          export DBT_BIGQUERY_KEYFILE="$(pwd)/meltano/keyfile.json"
          export DBT_BIGQUERY_PROJECT="$(echo $TF_VAR_sa_creds | base64 -d | jq -r '.project_id')"
          export DOCS_BUCKET_NAME="${TF_VAR_name_prefix}-lana-documents"

          RAW_PREFIX="${TF_VAR_name_prefix}"
          SAFE_PREFIX="$(printf '%s' "$RAW_PREFIX" | tr -c '[:alnum:]_' '_' )"
          export TARGET_BIGQUERY_DATASET="${SAFE_PREFIX}_dataset"
          export DBT_BIGQUERY_DATASET="dbt_${SAFE_PREFIX}"

          echo "DBT_BIGQUERY_KEYFILE=$DBT_BIGQUERY_KEYFILE" >> $GITHUB_ENV
          echo "DBT_BIGQUERY_PROJECT=$DBT_BIGQUERY_PROJECT" >> $GITHUB_ENV
          echo "TARGET_BIGQUERY_DATASET=$TARGET_BIGQUERY_DATASET" >> $GITHUB_ENV
          echo "DBT_BIGQUERY_DATASET=$DBT_BIGQUERY_DATASET" >> $GITHUB_ENV
          echo "DOCS_BUCKET_NAME=$DOCS_BUCKET_NAME" >> $GITHUB_ENV

          {
            echo "TARGET_BIGQUERY_CREDENTIALS_JSON<<EOF"
            cat meltano/keyfile.json
            echo "EOF"
          } >> "$GITHUB_ENV"
        env:
          TF_VAR_sa_creds: ${{ env.SA_CREDS }}
          SA_CREDS_BASE64: ${{ env.SA_CREDS }}
          TF_VAR_name_prefix: ${{ env.NAME_PREFIX }}

      - name: Install Meltano utilities
        run: nix develop -c meltano install utility sqlfluff
      - name: Run sqlfluff
        # Run through bash to cd into meltano because sqlfluff does not respect $MELTANO_PROJECT_ROOT
        run: |
          nix develop -c bash -lc '
            cd meltano
            .meltano/utilities/sqlfluff/venv/bin/pip install --quiet --upgrade platformdirs
            meltano invoke sqlfluff:lint
          '
