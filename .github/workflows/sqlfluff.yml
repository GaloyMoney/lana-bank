name: SQLFluff

on:
  pull_request:
    paths:
      - ".github/workflows/sqlfluff.yml"
      - "meltano/transform/models/**/*.sql"

permissions:
  contents: read

jobs:
  sqlfluff:
    name: Lint SQL with SQLFluff
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: pip

      - name: Install dbt + sqlfluff
        run: |
          python -m pip install --upgrade pip
          pip install \
            'dbt-bigquery==1.8.0' \
            'sqlfluff==3.4.2' \
            'sqlfluff-templater-dbt==3.4.2'

      - name: Configure credentials and env
        env:
          GOOGLE_SA_BASE64: ${{ secrets.GOOGLE_SA_BASE64 }}
        shell: bash
        run: |
          set -euo pipefail

          KEYFILE="$RUNNER_TEMP/keyfile.json"
          echo "${GOOGLE_SA_BASE64}" | base64 -d > "$KEYFILE"
          test -s "$KEYFILE"
          export KEYFILE

          PROJECT_ID=$(python - <<'PY'
          import json, os
          with open(os.environ["KEYFILE"]) as f:
            print(json.load(f)["project_id"])
          PY
          )
          SAFE_PREFIX="sqlfluff_${GITHUB_RUN_ID}_${GITHUB_RUN_ATTEMPT}"
          SAFE_PREFIX=$(printf '%s' "$SAFE_PREFIX" | tr -c '[:alnum:]_' '_' )

          {
            echo "GOOGLE_APPLICATION_CREDENTIALS=$KEYFILE"
            echo "DBT_PROFILES_DIR=${GITHUB_WORKSPACE}/meltano/transform/profiles/bigquery"
            echo "MELTANO_ENVIRONMENT=dev"
            echo "DBT_BIGQUERY_AUTH_METHOD=service-account"
            echo "DBT_BIGQUERY_KEYFILE=$KEYFILE"
            echo "DBT_BIGQUERY_PROJECT=$PROJECT_ID"
            echo "DBT_BIGQUERY_DATASET=dbt_${SAFE_PREFIX}"
          } >> "$GITHUB_ENV"

      - name: Prepare dbt target dir
        run: mkdir -p meltano/.meltano/transformers/dbt/target

      - name: Install dbt packages (dbt deps)
        working-directory: meltano/transform
        run: dbt deps

      - name: Run sqlfluff (dbt templater)
        working-directory: meltano
        run: |
          dbt --version
          sqlfluff --version
          sqlfluff lint --templater dbt --dialect bigquery transform/models
