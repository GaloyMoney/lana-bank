#@ load("@ytt:data", "data")

#@ def nix_flake_cachix_image_config():
type: registry-image
source:
  repository: ghcr.io/nix-community/docker-nixpkgs/cachix-flakes
  tag: latest-x86_64-linux
#@ end

#@ def next_version_task(resource_name="repo"):
task: next-version
config:
  platform: linux
  image_resource: #@ nix_flake_cachix_image_config()
  inputs:
  - name: #@ resource_name
    path: repo
  outputs:
  - name: version
  params:
    CACHIX_AUTH_TOKEN: #@ data.values.cachix_auth_token
    CACHIX_CACHE_NAME: #@ data.values.cachix_cache_name
  run:
    path: sh
    args:
      - -exc
      - |
        set -euo pipefail
        cd repo
        cachix use $CACHIX_CACHE_NAME
        nix run ./ci#next-version > ../version/version
#@ end

#@ def build_release(resource_name="repo"):
task: build-release
config:
  platform: linux
  image_resource: #@ nix_flake_cachix_image_config()
  inputs:
  - name: #@ resource_name
    path: repo
  - name: version
  params:
    CACHIX_AUTH_TOKEN: #@ data.values.cachix_auth_token
    CACHIX_CACHE_NAME: #@ data.values.cachix_cache_name
  run:
    path: sh
    args:
      - -exc
      - |
        set -euo pipefail
        export RELEASE_BUILD_VERSION=$(cat version/version)
        cd repo
        cachix use $CACHIX_CACHE_NAME
        cachix watch-exec ${CACHIX_CACHE_NAME} -- \
          nix build --impure .#lana-cli-release
#@ end

#@ def exec_phase(pkgs):
do:
- #@ check_latest_commit()
- #@ nix_build_and_cache(pkgs)
#@ end

#@ def nix_build_and_cache(pkgs, resource_name="prs"):
#@ pkg = pkgs[0]
task: #@ "cache-" + pkg
config:
  platform: linux
  image_resource: #@ nix_flake_cachix_image_config()
  inputs:
  - name: #@ resource_name
    path: repo
  params:
    CACHIX_AUTH_TOKEN: #@ data.values.cachix_auth_token
    CACHIX_CACHE_NAME: #@ data.values.cachix_cache_name
    BUILD_PACKAGES: #@ " ".join(pkgs)
  run:
    path: sh
    args:
      - -exc
      - |
        set -euo pipefail
        cd repo
        cachix use $CACHIX_CACHE_NAME
        for build_pkg in $BUILD_PACKAGES; do
          cachix watch-exec ${CACHIX_CACHE_NAME} -- nix build .#${build_pkg}
        done
#@ end


#@ def check_latest_commit():
task: check-latest-commit
config:
  platform: linux
  image_resource: #@ nix_flake_cachix_image_config()
  inputs:
  - name: prs
    path: repo
  params:
    GITHUB_TOKEN: #@ data.values.github_token
    GITHUB_ORG: #@ data.values.gh_org
    GITHUB_REPO: #@ data.values.gh_repository
    CACHIX_AUTH_TOKEN: #@ data.values.cachix_auth_token
    CACHIX_CACHE_NAME: #@ data.values.cachix_cache_name
  run:
    path: sh
    args:
      - -exc
      - |
        set -euo pipefail
        cd repo
        cachix use $CACHIX_CACHE_NAME
        nix run ./ci#check-latest-commit
#@ end
