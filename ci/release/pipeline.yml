#@ load("@ytt:data", "data")

#@ load("fragments.lib.yml",
#@   "public_gar_registry",
#@   "nodejs_task_image_config",
#@   "edge_image_resource",
#@   "version_resource",
#@   "gh_release_resource",
#@   "pipeline_tasks_resource",
#@   "release_task_image_config",
#@   "rust_task_image_config",
#@   "charts_repo_resource",
#@   "charts_repo_bot_branch",
#@   "private_gar_registry",
#@   "nix_task_image_config"
#@ )

#@ load("app-template.lib.yml",
#@   "app_src_resource",
#@   "app_src_resource_name",
#@   "build_app_edge_image_name",
#@   "app_edge_image_resource_name",
#@   "app_latest_image_resource_name",
#@   "app_latest_image",
#@   "build_app_edge_image",
#@   "app_edge_image",
#@   "nix_flake_cachix_image_config"
#@ )

groups:
  - name: lana-bank
    jobs:
      #! - auto-bump-patch
      - test-bats
      - test-integration
      - build-rc
      - release
      - flake-check
      - open-promote-rc-pr
      - bump-image-in-chart
      - bump-image-in-chart-rc
      -  #@ build_app_edge_image_name("admin-panel")
      -  #@ build_app_edge_image_name("customer-portal")
      - build-dagster-edge-image
jobs:
  #! - name: auto-bump-patch
  #!   serial: true
  #!   plan:
  #!     - get: repo
  #!       trigger: true
  #!       passed: [ release ]
  #!     - get: version
  #!       passed: [ release ]
  #!     - task: next-version
  #!       config:
  #!         platform: linux
  #!         image_resource: #@ nix_flake_cachix_image_config()
  #!         inputs:
  #!         - name: repo
  #!         outputs:
  #!         - name: version
  #!         params:
  #!           CACHIX_AUTH_TOKEN: #@ data.values.cachix_auth_token
  #!           CACHIX_CACHE_NAME: #@ data.values.cachix_cache_name
  #!         run:
  #!           path: sh
  #!           args:
  #!           - -exc
  #!           - |
  #!             set -euo pipefail
  #!             cachix use $CACHIX_CACHE_NAME
  #!             cd repo
  #!             nix run ./ci#next-version > ../version/version
  #!     - put: version
  #!       params:
  #!         bump: patch

  - name: test-integration
    serial: true
    plan:
      - in_parallel:
          - get: repo
            trigger: true
          - { get: pipeline-tasks }
      - task: run-nextest
        privileged: true
        config:
          platform: linux
          image_resource: #@ nix_flake_cachix_image_config()
          inputs:
          - name: repo
          params:
            CACHIX_AUTH_TOKEN: #@ data.values.cachix_auth_token
            CACHIX_CACHE_NAME: #@ data.values.cachix_cache_name
          run:
            path: sh
            args:
              - -exc
              - |
                set -euo pipefail
                cd repo
                cachix use $CACHIX_CACHE_NAME
                nix run .#nextest

  - name: test-bats
    serial: true
    plan:
      - in_parallel:
          - get: repo
            trigger: true
          - { get: pipeline-tasks }
      - task: run-bats
        privileged: true
        attempts: 2
        config:
          platform: linux
          image_resource: #@ nix_flake_cachix_image_config()
          inputs:
          - name: repo
          params:
            CACHIX_AUTH_TOKEN: #@ data.values.cachix_auth_token
            CACHIX_CACHE_NAME: #@ data.values.cachix_cache_name
          run:
            path: sh
            args:
              - -exc
              - |
                set -euo pipefail
                cd repo
                cachix use $CACHIX_CACHE_NAME
                DAGSTER=false nix run .#bats

  - name: flake-check
    serial: true
    plan:
    - get: repo
      trigger: true

    - task: nix-flake-check
      config:
        platform: linux
        image_resource: #@ nix_flake_cachix_image_config()
        inputs:
        - name: repo
        params:
          CACHIX_AUTH_TOKEN: #@ data.values.cachix_auth_token
          CACHIX_CACHE_NAME: #@ data.values.cachix_cache_name
        run:
          path: sh
          args:
            - -exc
            - |
              set -euo pipefail
              cd repo
              cachix use $CACHIX_CACHE_NAME

              nix flake check

  #! - name: await-release-binary
  #!   serial: true
  #!   serial_groups: [release]
  #!   plan:
  #!   - in_parallel:
  #!     - get: repo
  #!       trigger: true
  #!       passed: [ set-next-version ]
  #!     - get: version
  #!       passed: [ set-next-version ]
  #!   - task: await-release-binary
  #!     config:
  #!       platform: linux
  #!       image_resource: #@ nix_flake_cachix_image_config()
  #!       inputs:
  #!       - name: repo
  #!       - name: version
  #!       params:
  #!         CACHIX_AUTH_TOKEN: #@ data.values.cachix_auth_token
  #!         CACHIX_CACHE_NAME: #@ data.values.cachix_cache_name
  #!       run:
  #!         path: sh
  #!         args:
  #!         - -exc
  #!         - |
  #!           set -euo pipefail
  #!           cd repo
  #!
  #!           cachix use $CACHIX_CACHE_NAME
  #!           export RELEASE_BUILD_VERSION=$(cat ../version/version)
  #!           
  #!           nix build --impure .#lana-cli-release --dry-run --json | \
  #!             nix run nixpkgs#jq -- -r '.[].outputs.out' \
  #!             > nix-checks-paths.txt
  #!           echo "Checks to wait for:"
  #!           cat nix-checks-paths.txt
  #!
  #!           nix run ./ci#wait-cachix-paths -- \
  #!             -p ./nix-checks-paths.txt \
  #!             -c galoymoney \
  #!             -a 300 \
  #!             -d 10

  - name: build-rc
    serial: true
    plan:
      - in_parallel:
          - get: repo
            passed: 
              - flake-check
              - test-bats
              - test-integration
            trigger: true
          - get: pipeline-tasks
          - get: version
          - get: admin-panel-src
            passed:
              -  build-admin-panel-edge-image
          - get: customer-portal-src
            passed:
              -  build-customer-portal-edge-image
          - get: dagster-edge-image
            trigger: true
            params: { format: oci }
            passed:
              - build-dagster-edge-image
      - task: prep-release-apps
        config:
          platform: linux
          image_resource: #@ release_task_image_config()
          inputs:
            - name: pipeline-tasks
            - name: version
            - name: admin-panel-src
            - name: customer-portal-src
          outputs:
            - name: admin-panel-src
            - name: customer-portal-src
          run:
            path: pipeline-tasks/ci/tasks/prep-release-apps.sh
      - task: next-version
        config:
          platform: linux
          image_resource: #@ nix_flake_cachix_image_config()
          inputs:
          - name: version
          - name: repo
          outputs:
          - name: version
          run:
            path: sh
            args:
            - -exc
            - |
              set -euo pipefail
              cd repo
              nix run ci/.#next-version > ../version/version
      - task: nix-build-release
        attempts: 2
        config:
          platform: linux
          image_resource: #@ nix_flake_cachix_image_config()
          inputs:
          - name: repo
          - name: version
          outputs:
          - name: binaries
          params:
            CACHIX_AUTH_TOKEN: #@ data.values.cachix_auth_token
            CACHIX_CACHE_NAME: #@ data.values.cachix_cache_name
          run:
            path: sh
            args:
            - -exc
            - |
              set -euo pipefail
              cachix use $CACHIX_CACHE_NAME
              cd repo
              export RELEASE_BUILD_VERSION=$(cat ../version/version)
              nix build --impure .#lana-cli-release
              cp result/bin/lana-cli ../binaries/
      - task: prepare-docker-build
        config:
          platform: linux
          image_resource: #@ rust_task_image_config()
          inputs:
            - name: pipeline-tasks
            - name: repo
            - name: version
            - name: binaries
          outputs:
            - name: repo
          run:
            path: pipeline-tasks/ci/tasks/prep-docker-build-env.sh
      - task: build-docker-image
        privileged: true
        config:
          platform: linux
          image_resource:
            type: registry-image
            source:
              repository: concourse/oci-build-task
          inputs:
            - name: repo
          outputs:
            - name: image
          params:
            CONTEXT: repo
            BUILD_ARGS_FILE: repo/.env
            DOCKERFILE: repo/Dockerfile.rc
          run:
            path: build
      - put: latest-image
        params:
          image: image/image.tar
          additional_tags: version/version
      - put: version
        params:
          file: version/version
      - put: repo
        params:
          tag: version/version
          only_tag: true
          repository: repo
      - in_parallel:
        - do:
          - task: build-admin-panel-release
            attempts: 2
            privileged: true
            config:
              platform: linux
              image_resource:
                type: registry-image
                source:
                  repository: concourse/oci-build-task
              inputs:
                - name: admin-panel-src
              outputs:
                - name: admin-panel-image
                  path: image
              params:
                CONTEXT: admin-panel-src
                DOCKERFILE: admin-panel-src/apps/admin-panel/Dockerfile
              run:
                path: build
          - put: admin-panel-latest-image
            params:
              image: admin-panel-image/image.tar
              additional_tags: version/version
        - do:
          - task: build-customer-portal-release
            attempts: 2
            privileged: true
            config:
              platform: linux
              image_resource:
                type: registry-image
                source:
                  repository: concourse/oci-build-task
              inputs:
                - name: customer-portal-src
              outputs:
                - name: customer-portal-image
                  path: image
              params:
                CONTEXT: customer-portal-src
                DOCKERFILE: customer-portal-src/apps/customer-portal/Dockerfile
              run:
                path: build
          - put: customer-portal-latest-image
            params:
              image: customer-portal-image/image.tar
              additional_tags: version/version
      - put: dagster-edge-image
        params:
          image: dagster-edge-image/image.tar
          additional_tags: version/version

  - name: release
    serial: true
    plan:
      - in_parallel:
          - get: promote-rc-pr
            trigger: true
          - get: repo
            passed: [ open-promote-rc-pr ]
          - get: pipeline-tasks
          - get: version
            passed: [ open-promote-rc-pr ]
            params: { bump: final }
          - get: #@ app_src_resource_name("admin-panel")
            passed: [ build-rc ]
          - get: #@ app_src_resource_name("customer-portal")
            passed: [ build-rc ]
          - get: dagster-edge-image
            params: { format: oci }
            passed: [ build-rc ]
      - in_parallel:
        - task: prep-release
          config:
            platform: linux
            image_resource: #@ release_task_image_config()
            inputs:
              - name: pipeline-tasks
              - name: repo
              - name: version
            outputs:
              - name: artifacts
            run:
              path: pipeline-tasks/ci/tasks/prep-release-src.sh
        - task: prep-release-apps
          config:
            platform: linux
            image_resource: #@ release_task_image_config()
            inputs:
              - name: pipeline-tasks
              - name: version
              - name: #@ app_src_resource_name("admin-panel")
                path: admin-panel-src
              - name: #@ app_src_resource_name("customer-portal")
                path: customer-portal-src
            outputs:
              - name: #@ app_src_resource_name("admin-panel")
                path: admin-panel-src
              - name: #@ app_src_resource_name("customer-portal")
                path: customer-portal-src
            run:
              path: pipeline-tasks/ci/tasks/prep-release-apps.sh
        - task: nix-build-release
          attempts: 2
          config:
            platform: linux
            image_resource: #@ nix_flake_cachix_image_config()
            inputs:
            - name: repo
            - name: version
            outputs:
            - name: binaries
            params:
              CACHIX_AUTH_TOKEN: #@ data.values.cachix_auth_token
              CACHIX_CACHE_NAME: #@ data.values.cachix_cache_name
            run:
              path: sh
              args:
              - -exc
              - |
                set -euo pipefail
                cachix use $CACHIX_CACHE_NAME
                cd repo
                export RELEASE_BUILD_VERSION=$(cat ../version/version)
                nix build --impure .#lana-cli-release
                mkdir -p ../bin
                cp result/bin/lana-cli ../binaries/
      - in_parallel:
        - do:
          - task: build-admin-panel-release
            attempts: 2
            privileged: true
            config:
              platform: linux
              image_resource:
                type: registry-image
                source:
                  repository: concourse/oci-build-task
              inputs:
                - name: admin-panel-src
              outputs:
                - name: admin-panel-image
                  path: image
              params:
                CONTEXT: admin-panel-src
                DOCKERFILE: admin-panel-src/apps/admin-panel/Dockerfile
              run:
                path: build
          - put: #@ app_latest_image_resource_name("admin-panel")
            params:
              image: admin-panel-image/image.tar
              additional_tags: version/version
        - do:
          - task: build-customer-portal-release
            attempts: 2
            privileged: true
            config:
              platform: linux
              image_resource:
                type: registry-image
                source:
                  repository: concourse/oci-build-task
              inputs:
                - name: customer-portal-src
              outputs:
                - name: customer-portal-image
                  path: image
              params:
                CONTEXT: customer-portal-src
                DOCKERFILE: customer-portal-src/apps/customer-portal/Dockerfile
              run:
                path: build
          - put: #@ app_latest_image_resource_name("customer-portal")
            params:
              image: customer-portal-image/image.tar
              additional_tags: version/version
      - task: prepare-docker-build
        config:
          platform: linux
          image_resource: #@ rust_task_image_config()
          inputs:
            - name: pipeline-tasks
            - name: repo
            - name: version
          outputs:
            - name: repo
          params:
            GH_APP_ID: #@ data.values.github_app_id
            GH_APP_PRIVATE_KEY: #@ data.values.github_app_private_key
          run:
            path: pipeline-tasks/ci/tasks/prep-docker-build-env.sh
      - task: build-docker-image
        privileged: true
        config:
          platform: linux
          image_resource:
            type: registry-image
            source:
              repository: concourse/oci-build-task
          inputs:
            - name: repo
          outputs:
            - name: image
          params:
            CONTEXT: repo
            BUILD_ARGS_FILE: repo/.env
            DOCKERFILE: repo/Dockerfile.release
          run:
            path: build
      - in_parallel:
        - put: latest-image
          params:
            image: image/image.tar
            additional_tags: version/version
        - put: dagster-latest-image
          params:
            image: dagster-edge-image/image.tar
            additional_tags: version/version
      - put: version
        params:
          file: version/version
      - put: gh-release
        params:
          name: artifacts/gh-release-name
          tag: artifacts/gh-release-tag
          body: artifacts/gh-release-notes.md
          globs: [binaries/*]
          commitish: repo/.git/HEAD
  
  - name: bump-image-in-chart
    plan:
      - in_parallel:
          - get: latest-image
            passed: [release]
            params: { skip_download: true }
          - get: #@ app_latest_image_resource_name("admin-panel")
          - get: #@ app_latest_image_resource_name("customer-portal")
          - get: dagster-latest-image
            passed: [release]
            params: { skip_download: true }
          - get: repo
            trigger: true
            passed: [release]
          - get: version
            trigger: true
            passed: [release]
          - get: charts-repo
            params: { skip_download: true }
          - get: pipeline-tasks
      - task: bump-image-digest-in-values
        config:
          platform: linux
          image_resource: #@ rust_task_image_config()
          inputs:
            - name: repo
            - name: latest-image
            - name: #@ app_latest_image_resource_name("admin-panel")
            - name: #@ app_latest_image_resource_name("customer-portal")
            - name: dagster-latest-image
              path: dagster-image
            - name: pipeline-tasks
            - name: charts-repo
            - name: version
          outputs:
            - name: charts-repo
          params:
            BRANCH: #@ data.values.git_charts_branch
            CHARTS_SUBDIR: lana-bank
          run:
            path: pipeline-tasks/ci/tasks/bump-image-digest.sh
      - put: charts-repo-bot-branch
        params:
          repository: charts-repo
          force: true
      - task: open-charts-pr
        config:
          platform: linux
          image_resource: #@ rust_task_image_config()
          inputs:
            - name: pipeline-tasks
            - name: latest-image
            - name: charts-repo
            - name: repo
          params:
            GH_APP_ID: #@ data.values.github_app_id
            GH_APP_PRIVATE_KEY: #@ data.values.github_app_private_key
            BRANCH: #@ data.values.git_charts_branch
            BOT_BRANCH: #@ data.values.git_charts_bot_branch
            CHARTS_SUBDIR: lana-bank
          run:
            path: pipeline-tasks/ci/tasks/chart-open-charts-pr.sh

  - name: bump-image-in-chart-rc
    plan:
      - in_parallel:
          - get: latest-image
            passed: [build-rc]
            params: { skip_download: true }
          - get: #@ app_latest_image_resource_name("admin-panel")
          - get: #@ app_latest_image_resource_name("customer-portal")
          - get: dagster-edge-image
            passed: [build-rc]
            params: { skip_download: true }
          - get: repo
            trigger: true
            passed: [build-rc]
          - get: version
            trigger: true
            passed: [build-rc]
          - get: charts-repo
            params: { skip_download: true }
          - get: pipeline-tasks
      - task: bump-image-digest-in-values
        config:
          platform: linux
          image_resource: #@ rust_task_image_config()
          inputs:
            - name: repo
            - name: latest-image
            - name: #@ app_latest_image_resource_name("admin-panel")
            - name: #@ app_latest_image_resource_name("customer-portal")
            - name: dagster-edge-image
              path: dagster-image
            - name: pipeline-tasks
            - name: charts-repo
            - name: version
          outputs:
            - name: charts-repo
          params:
            BRANCH: #@ data.values.git_charts_branch
            CHARTS_SUBDIR: lana-bank
          run:
            path: pipeline-tasks/ci/tasks/bump-image-digest.sh
      - put: charts-repo-bot-branch
        params:
          repository: charts-repo
          force: true
      - task: open-charts-pr
        config:
          platform: linux
          image_resource: #@ rust_task_image_config()
          inputs:
            - name: pipeline-tasks
            - name: latest-image
            - name: charts-repo
            - name: repo
          params:
            GH_APP_ID: #@ data.values.github_app_id
            GH_APP_PRIVATE_KEY: #@ data.values.github_app_private_key
            BRANCH: #@ data.values.git_charts_branch
            BOT_BRANCH: #@ data.values.git_charts_bot_branch
            CHARTS_SUBDIR: lana-bank
          run:
            path: pipeline-tasks/ci/tasks/chart-open-charts-pr.sh

  -  #@ build_app_edge_image("admin-panel")
  -  #@ build_app_edge_image("customer-portal")

  - name: build-dagster-edge-image
    serial: true
    plan:
      - get: dagster-src
        trigger: true
      - task: build
        privileged: true
        config:
          platform: linux
          image_resource:
            type: registry-image
            source:
              repository: concourse/oci-build-task
          inputs:
          - name: dagster-src
            path: repo
          outputs:
          - name: image
          params:
            CONTEXT: repo/dagster
            DOCKERFILE: repo/dagster/Dockerfile
          run:
            path: build
      - put: dagster-edge-image
        params:
          image: image/image.tar

  - name: open-promote-rc-pr
    plan:
      - in_parallel:
          - get: version
            passed: [build-rc]
            params: { bump: final }
            trigger: true
          - get: pipeline-tasks
          - get: repo
            passed: [build-rc]
      - task: update-changelog
        config:
          platform: linux
          image_resource: #@ nix_flake_cachix_image_config()
          inputs:
            - name: version
            - name: repo
          outputs:
            - name: repo
          params:
            CACHIX_AUTH_TOKEN: #@ data.values.cachix_auth_token
            CACHIX_CACHE_NAME: #@ data.values.cachix_cache_name
          run:
            path: /bin/bash
            args:
              - -exc
              - |
                set -euo pipefail
                cd repo
                cachix use $CACHIX_CACHE_NAME
                VERSION=$(cat ../version/version)
                nix run ci/.#update-changelog $VERSION
                if [[ -z $(git config --global user.email) ]]; then
                  git config --global user.email "bot@galoy.io"
                fi
                if [[ -z $(git config --global user.name) ]]; then
                  git config --global user.name "CI Bot"
                fi
                git add CHANGELOG.md
                git commit -m "ci: release ${VERSION} [ci skip]"
      - put: repo-bot-branch
        params:
          repository: repo
          branch: #@ data.values.git_promote_rc_branch
          force: true
      - task: open-promote-pr
        config:
          platform: linux
          image_resource: #@ rust_task_image_config()
          inputs:
            - name: pipeline-tasks
            - name: version
            - name: repo
          params:
            GH_APP_ID: #@ data.values.github_app_id
            GH_APP_PRIVATE_KEY: #@ data.values.github_app_private_key
            BRANCH: #@ data.values.git_branch
            BOT_BRANCH: #@ data.values.git_promote_rc_branch
          run:
            path: pipeline-tasks/ci/tasks/open-promote-rc-pr.sh

resources:
  - name: repo
    type: git
    source:
      ignore_paths:
        - "ci/*[^mdxk]"
        - apps/**/*
      fetch_tags: true
      uri: #@ data.values.git_uri
      branch: #@ data.values.git_branch
      private_key: #@ data.values.github_private_key
    webhook_token: ((webhook.secret))

  - name: repo-bot-branch
    type: git
    source:
      uri: #@ data.values.git_uri
      branch: #@ data.values.git_promote_rc_branch
      private_key: #@ data.values.github_private_key
    webhook_token: ((webhook.secret))

  - name: promote-rc-pr
    type: pull-request
    source:
      repository: #@ data.values.gh_org + "/" + data.values.gh_repository
      access_token: #@ data.values.github_token
      base_branch: #@ data.values.git_branch
      disable_forks: true
      disable_ci_skip: true
      states: [ "MERGED" ]
      paths: [ "CHANGELOG.md" ]
      labels: [ "promote-rc" ]

  - name: latest-image
    type: registry-image
    source:
      tag: latest
      username: #@ data.values.gar_registry_user
      password: #@ data.values.gar_registry_password
      repository: #@ private_gar_registry() + "/" + data.values.folder_registry_image

  - name: dagster-edge-image
    type: registry-image
    source:
      tag: edge
      username: #@ data.values.gar_registry_user
      password: #@ data.values.gar_registry_password
      repository: #@ public_gar_registry() + "/dagster-code-location-lana-dw"

  - name: dagster-latest-image
    type: registry-image
    source:
      tag: latest
      username: #@ data.values.gar_registry_user
      password: #@ data.values.gar_registry_password
      repository: #@ public_gar_registry() + "/dagster-code-location-lana-dw"

  -  #@ pipeline_tasks_resource()
  -  #@ version_resource()
  -  #@ gh_release_resource()
  -  #@ charts_repo_bot_branch()
  -  #@ charts_repo_resource()
  -  #@ app_src_resource("admin-panel", "main")
  -  #@ app_edge_image("admin-panel")
  -  #@ app_latest_image("admin-panel")
  -  #@ app_src_resource("customer-portal", "main")
  -  #@ app_edge_image("customer-portal")
  -  #@ app_latest_image("customer-portal")
  - name: dagster-src
    type: git
    source:
      paths:
      - dagster/*
      uri: #@ data.values.git_uri
      branch: #@ data.values.git_branch
      private_key: #@ data.values.github_private_key
    webhook_token: ((webhook.secret))

resource_types:
- name: pull-request
  type: docker-image
  source:
    repository: teliaoss/github-pr-resource
