mutation CompleteLoanTemplateCreate(
  $templateId: UUID!
  $journalId: Expression!
  $bankCollateralAccountId: Expression!
) {
  txTemplateCreate(
    input: {
      txTemplateId: $templateId
      code: "COMPLETE_LOAN"
      description: "Make final payment for loan and release collateral."
      params: [
        {
          name: "checkingAccount"
          type: UUID
          description: "User Checking account ID."
        }
        {
          name: "loanPrincipalReceivableAccount"
          type: UUID
          description: "Loan principal amount outstanding account ID."
        }
        {
          name: "loanInterestReceivableAccount"
          type: UUID
          description: "Loan interest amount outstanding account ID."
        }
        {
          name: "loanCollateralAccount"
          type: UUID
          description: "Loan Collateral account ID."
        }
        {
          name: "principalPaymentAmount"
          type: DECIMAL
          description: "Amount of USD being paid against outstanding principal amount."
        }
        {
          name: "interestPaymentAmount"
          type: DECIMAL
          description: "Amount of USD being paid against outstanding interest amount."
        }
        {
          name: "collateralAmount"
          type: DECIMAL
          description: "Amount of BTC being put into the loan."
        }
        {
          name: "externalId"
          type: STRING
          description: "External ID for the transaction"
        }
        {
          name: "effective"
          type: DATE
          description: "Effective date for transaction."
          default: "date()"
        }
      ]
      transaction: {
        journalId: $journalId
        effective: "params.effective"
        externalId: "params.externalId"
      }
      entries: [
        {
          accountId: "params.checkingAccount"
          units: "params.principalPaymentAmount + params.interestPaymentAmount"
          currency: "'USD'"
          entryType: "'COMPLETE_LOAN_PAYMENT_DR'"
          direction: "DEBIT"
          layer: "SETTLED"
        }
        {
          accountId: "params.loanPrincipalReceivableAccount"
          units: "params.principalPaymentAmount"
          currency: "'USD'"
          entryType: "'COMPLETE_LOAN_PRINCIPAL_PAYMENT_CR'"
          direction: "CREDIT"
          layer: "SETTLED"
        }
        {
          accountId: "params.loanInterestReceivableAccount"
          units: "params.interestPaymentAmount"
          currency: "'USD'"
          entryType: "'COMPLETE_LOAN_INTEREST_PAYMENT_CR'"
          direction: "CREDIT"
          layer: "SETTLED"
        }
        {
          accountId: "params.loanCollateralAccount"
          units: "params.collateralAmount"
          currency: "'BTC'"
          entryType: "'COMPLETE_LOAN_COLLATERAL_DR'"
          direction: "DEBIT"
          layer: "SETTLED"
        }
        {
          accountId: $bankCollateralAccountId
          units: "params.collateralAmount"
          currency: "'BTC'"
          entryType: "'COMPLETE_LOAN_COLLATERAL_CR'"
          direction: "CREDIT"
          layer: "SETTLED"
        }
      ]
    }
  ) {
    txTemplate {
      txTemplateId
      code
      version
    }
  }
}

mutation PostCompleteLoanTransaction(
  $transactionId: UUID!
  $checkingAccount: UUID!
  $loanPrincipalReceivableAccount: UUID!
  $loanInterestReceivableAccount: UUID!
  $loanCollateralAccount: UUID!
  $principalPaymentAmount: Decimal!
  $interestPaymentAmount: Decimal!
  $collateralAmount: Decimal!
  $externalId: String!
) {
  transactionPost(
    input: {
      transactionId: $transactionId
      txTemplateCode: "COMPLETE_LOAN"
      params: {
        checkingAccount: $checkingAccount
        loanPrincipalReceivableAccount: $loanPrincipalReceivableAccount
        loanInterestReceivableAccount: $loanInterestReceivableAccount
        loanCollateralAccount: $loanCollateralAccount
        principalPaymentAmount: $principalPaymentAmount
        interestPaymentAmount: $interestPaymentAmount
        collateralAmount: $collateralAmount
        externalId: $externalId
      }
    }
  ) {
    transaction {
      transactionId
      correlationId
    }
  }
}
